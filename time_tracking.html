<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracking</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        label {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-weight: bold;
        }
        input, textarea {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .message {
            padding: 10px;
            border-radius: 4px;
            margin-top: 20px;
            text-align: center;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        a {
            display: inline-block;
            margin-bottom: 20px;
            color: #4CAF50;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .previous-entry {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .previous-entry h3 {
            margin-top: 0;
            color: #666;
        }
        .previous-entry-field {
            margin-bottom: 10px;
        }
        .previous-entry-field strong {
            color: #333;
        }
        .readonly-field {
            background-color: #f0f0f0;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <a href="index.html">← Back to Home</a> | <a href="report.html">View Reports →</a>
    <h1>Time Tracking Form</h1>
    
    <form id="timeTrackingForm">
        <label>
            Date:
            <input type="date" id="date" name="date" required>
        </label>
        
        <label>
            Start Time:
            <input type="time" id="startTime" name="startTime" required>
        </label>
        
        <label>
            End Time:
            <input type="time" id="endTime" name="endTime" required>
        </label>
        
        <label>
            Todo:
            <textarea id="todo" name="todo" placeholder="What did you plan to do?"></textarea>
        </label>
        
        <div id="previousEntry" class="previous-entry" style="display: none;">
            <h3>Previous Entry</h3>
            <div class="previous-entry-field">
                <strong>Time:</strong> <span id="prevTimeRange"></span>
            </div>
            <div class="previous-entry-field">
                <strong>Todo:</strong> <span id="prevTodo"></span>
            </div>
        </div>
        
        <label>
            Done (Updates Previous Entry):
            <textarea id="done" name="done" placeholder="What did you accomplish in the previous time window?"></textarea>
        </label>
        
        <label>
            Forfeit:
            <textarea id="forfeit" name="forfeit" placeholder="What did you forfeit?"></textarea>
        </label>
        
        <label>
            Freedom:
            <textarea id="freedom" name="freedom" placeholder="How did you maintain freedom?"></textarea>
        </label>
        
        <button type="submit">Submit Entry</button>
    </form>
    
    <div id="message"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, addDoc, Timestamp, query, orderBy, limit, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAv2tgr09braWjrKSsyZNbw9ZgdGyrZIDM",
            authDomain: "tracking-17d26.firebaseapp.com",
            projectId: "tracking-17d26",
            storageBucket: "tracking-17d26.firebasestorage.app",
            messagingSenderId: "506730679610",
            appId: "1:506730679610:web:8f28cbc0a5f05f37ab1403"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let previousEntryId = null;

        // Set today's date as default
        document.getElementById('date').valueAsDate = new Date();
        
        // Auto-populate start and end times
        function setDefaultTimes() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            
            // Round down to nearest 30 minutes
            const roundedMinutes = minutes < 30 ? 0 : 30;
            
            // Create start time
            const startTime = new Date();
            startTime.setHours(hours);
            startTime.setMinutes(roundedMinutes);
            startTime.setSeconds(0);
            
            // Create end time (1 hour later)
            const endTime = new Date(startTime);
            endTime.setHours(endTime.getHours() + 1);
            
            // Format times as HH:MM
            const formatTime = (date) => {
                const h = date.getHours().toString().padStart(2, '0');
                const m = date.getMinutes().toString().padStart(2, '0');
                return `${h}:${m}`;
            };
            
            document.getElementById('startTime').value = formatTime(startTime);
            document.getElementById('endTime').value = formatTime(endTime);
        }
        
        // Load and display previous entry
        async function loadPreviousEntry() {
            try {
                const q = query(collection(db, 'hourly_tracking'), orderBy('StartTime', 'desc'), limit(1));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    const data = doc.data();
                    previousEntryId = doc.id;
                    
                    // Format times
                    const startTime = data.StartTime.toDate();
                    const endTime = data.EndTime.toDate();
                    const formatTime = (date) => {
                        const h = date.getHours().toString().padStart(2, '0');
                        const m = date.getMinutes().toString().padStart(2, '0');
                        return `${h}:${m}`;
                    };
                    
                    // Display previous entry info
                    document.getElementById('prevTimeRange').textContent = 
                        `${formatTime(startTime)} - ${formatTime(endTime)}`;
                    document.getElementById('prevTodo').textContent = data.Todo || '(No todo)';
                    document.getElementById('previousEntry').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading previous entry:', error);
            }
        }
        
        // Set default times on page load
        setDefaultTimes();
        loadPreviousEntry();

        // Handle form submission
        document.getElementById('timeTrackingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const messageDiv = document.getElementById('message');
            
            try {
                // Get form values
                const date = document.getElementById('date').value;
                const startTime = document.getElementById('startTime').value;
                const endTime = document.getElementById('endTime').value;
                const todo = document.getElementById('todo').value;
                const doneValue = document.getElementById('done').value;
                const forfeit = document.getElementById('forfeit').value;
                const freedom = document.getElementById('freedom').value;
                
                // Update previous entry's done field if we have a value
                if (previousEntryId && doneValue) {
                    const prevDocRef = doc(db, 'hourly_tracking', previousEntryId);
                    await updateDoc(prevDocRef, {
                        Done: doneValue
                    });
                }
                
                // Create datetime objects
                const startDateTime = new Date(`${date}T${startTime}`);
                const endDateTime = new Date(`${date}T${endTime}`);
                
                // Add new document to Firestore (with empty Done field)
                await addDoc(collection(db, 'hourly_tracking'), {
                    StartTime: Timestamp.fromDate(startDateTime),
                    EndTime: Timestamp.fromDate(endDateTime),
                    Todo: todo,
                    Done: '', // Always empty for new entries
                    Forfeit: forfeit,
                    Freedom: freedom
                });
                
                // Show success message
                messageDiv.className = 'message success';
                messageDiv.textContent = 'Entry saved successfully!';
                
                // Reset form
                document.getElementById('timeTrackingForm').reset();
                document.getElementById('date').valueAsDate = new Date();
                setDefaultTimes();
                
                // Reload previous entry (which is now the entry we just created)
                loadPreviousEntry();
                
            } catch (error) {
                // Show error message
                messageDiv.className = 'message error';
                messageDiv.textContent = 'Error saving entry: ' + error.message;
            }
        });
    </script>
</body>
</html>
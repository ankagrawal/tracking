<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracking Report</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .controls {
            text-align: center;
            margin-bottom: 30px;
        }
        .date-selector {
            padding: 8px 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .time-cell {
            white-space: nowrap;
        }
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        a {
            display: inline-block;
            margin-bottom: 20px;
            color: #4CAF50;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .empty-cell {
            color: #999;
            font-style: italic;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        .edit-btn, .delete-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .edit-btn {
            background-color: #2196F3;
            color: white;
        }
        .edit-btn:hover {
            background-color: #1976D2;
        }
        .delete-btn {
            background-color: #f44336;
            color: white;
        }
        .delete-btn:hover {
            background-color: #d32f2f;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
        }
        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        .modal-form label {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-weight: bold;
        }
        .modal-form input, .modal-form textarea {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .modal-form textarea {
            min-height: 60px;
            resize: vertical;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .save-btn, .cancel-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .save-btn {
            background-color: #4CAF50;
            color: white;
        }
        .save-btn:hover {
            background-color: #45a049;
        }
        .cancel-btn {
            background-color: #ddd;
            color: #333;
        }
        .cancel-btn:hover {
            background-color: #ccc;
        }
    </style>
</head>
<body>
    <a href="index.html">← Back to Home</a> | <a href="time_tracking.html">Add Entry →</a>
    <h1>Time Tracking Report</h1>
    
    <div class="controls">
        <label for="dateSelector">Select Date: </label>
        <select id="dateSelector" class="date-selector">
            <option value="">Loading dates...</option>
        </select>
    </div>
    
    <div id="reportContent">
        <div class="loading">Loading entries...</div>
    </div>
    
    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Edit Entry</h2>
            <form id="editForm" class="modal-form">
                <label>
                    Date:
                    <input type="date" id="editDate" required>
                </label>
                <label>
                    Start Time:
                    <input type="time" id="editStartTime" required>
                </label>
                <label>
                    End Time:
                    <input type="time" id="editEndTime" required>
                </label>
                <label>
                    Todo:
                    <textarea id="editTodo"></textarea>
                </label>
                <label>
                    Done:
                    <textarea id="editDone"></textarea>
                </label>
                <label>
                    Forfeit:
                    <textarea id="editForfeit"></textarea>
                </label>
                <label>
                    Freedom:
                    <textarea id="editFreedom"></textarea>
                </label>
                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="save-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, query, orderBy, getDocs, where, Timestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAv2tgr09braWjrKSsyZNbw9ZgdGyrZIDM",
            authDomain: "tracking-17d26.firebaseapp.com",
            projectId: "tracking-17d26",
            storageBucket: "tracking-17d26.firebasestorage.app",
            messagingSenderId: "506730679610",
            appId: "1:506730679610:web:8f28cbc0a5f05f37ab1403"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const dateSelector = document.getElementById('dateSelector');
        const reportContent = document.getElementById('reportContent');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        
        let currentEditId = null;
        let entriesData = new Map();

        // Format date for display
        function formatDate(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        // Format time for display
        function formatTime(date) {
            const h = date.getHours().toString().padStart(2, '0');
            const m = date.getMinutes().toString().padStart(2, '0');
            return `${h}:${m}`;
        }

        // Get all unique dates from the database
        async function loadAvailableDates() {
            try {
                const q = query(collection(db, 'hourly_tracking'), orderBy('StartTime', 'desc'));
                const querySnapshot = await getDocs(q);
                
                const uniqueDates = new Map();
                let latestDate = null;
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const startTime = data.StartTime.toDate();
                    const dateStr = startTime.toDateString();
                    const dateKey = startTime.toISOString().split('T')[0];
                    
                    if (!uniqueDates.has(dateKey)) {
                        uniqueDates.set(dateKey, dateStr);
                    }
                    
                    if (!latestDate) {
                        latestDate = dateKey;
                    }
                });
                
                // Clear and populate dropdown
                dateSelector.innerHTML = '';
                
                if (uniqueDates.size === 0) {
                    dateSelector.innerHTML = '<option value="">No entries found</option>';
                    displayNoData();
                    return;
                }
                
                // Add today as first option if not already in data
                const today = new Date().toISOString().split('T')[0];
                const todayStr = new Date().toDateString();
                
                if (!uniqueDates.has(today)) {
                    const option = document.createElement('option');
                    option.value = today;
                    option.textContent = `${formatDate(new Date())} (Today)`;
                    dateSelector.appendChild(option);
                }
                
                // Add all dates from database
                Array.from(uniqueDates.entries())
                    .sort((a, b) => b[0].localeCompare(a[0]))
                    .forEach(([dateKey, dateStr]) => {
                        const option = document.createElement('option');
                        option.value = dateKey;
                        const date = new Date(dateStr);
                        option.textContent = formatDate(date);
                        if (dateKey === today) {
                            option.textContent += ' (Today)';
                        }
                        dateSelector.appendChild(option);
                    });
                
                // Select today if it has entries, otherwise select the latest date
                if (uniqueDates.has(today)) {
                    dateSelector.value = today;
                    await loadEntriesForDate(today);
                } else if (latestDate) {
                    dateSelector.value = latestDate;
                    await loadEntriesForDate(latestDate);
                }
                
            } catch (error) {
                console.error('Error loading dates:', error);
                dateSelector.innerHTML = '<option value="">Error loading dates</option>';
            }
        }

        // Load entries for a specific date
        async function loadEntriesForDate(dateStr) {
            try {
                reportContent.innerHTML = '<div class="loading">Loading entries...</div>';
                entriesData.clear();
                
                const selectedDate = new Date(dateStr);
                const startOfDay = new Date(selectedDate);
                startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(selectedDate);
                endOfDay.setHours(23, 59, 59, 999);
                
                const q = query(
                    collection(db, 'hourly_tracking'),
                    where('StartTime', '>=', Timestamp.fromDate(startOfDay)),
                    where('StartTime', '<=', Timestamp.fromDate(endOfDay)),
                    orderBy('StartTime', 'asc')
                );
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    displayNoData();
                    return;
                }
                
                // Create table
                let tableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Time Range</th>
                                <th>Todo</th>
                                <th>Done</th>
                                <th>Forfeit</th>
                                <th>Freedom</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                querySnapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    const docId = docSnapshot.id;
                    const startTime = data.StartTime.toDate();
                    const endTime = data.EndTime.toDate();
                    
                    // Store entry data for editing
                    entriesData.set(docId, { ...data, id: docId });
                    
                    tableHTML += `
                        <tr>
                            <td class="time-cell">${formatTime(startTime)} - ${formatTime(endTime)}</td>
                            <td>${data.Todo || '<span class="empty-cell">-</span>'}</td>
                            <td>${data.Done || '<span class="empty-cell">-</span>'}</td>
                            <td>${data.Forfeit || '<span class="empty-cell">-</span>'}</td>
                            <td>${data.Freedom || '<span class="empty-cell">-</span>'}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="edit-btn" onclick="editEntry('${docId}')">Edit</button>
                                    <button class="delete-btn" onclick="deleteEntry('${docId}')">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
                
                reportContent.innerHTML = tableHTML;
                
            } catch (error) {
                console.error('Error loading entries:', error);
                reportContent.innerHTML = '<div class="no-data">Error loading entries. Please try again.</div>';
            }
        }

        function displayNoData() {
            reportContent.innerHTML = '<div class="no-data">No entries found for this date.</div>';
        }

        // Event listener for date selection
        dateSelector.addEventListener('change', (e) => {
            const selectedDate = e.target.value;
            if (selectedDate) {
                loadEntriesForDate(selectedDate);
            }
        });

        // Edit entry function
        window.editEntry = function(docId) {
            currentEditId = docId;
            const data = entriesData.get(docId);
            
            if (!data) {
                alert('Entry data not found');
                return;
            }
            
            // Populate form with existing data
            const startTime = data.StartTime.toDate();
            const endTime = data.EndTime.toDate();
            
            document.getElementById('editDate').value = startTime.toISOString().split('T')[0];
            document.getElementById('editStartTime').value = formatTime(startTime);
            document.getElementById('editEndTime').value = formatTime(endTime);
            document.getElementById('editTodo').value = data.Todo || '';
            document.getElementById('editDone').value = data.Done || '';
            document.getElementById('editForfeit').value = data.Forfeit || '';
            document.getElementById('editFreedom').value = data.Freedom || '';
            
            editModal.style.display = 'block';
        };
        
        // Delete entry function
        window.deleteEntry = async function(docId) {
            if (confirm('Are you sure you want to delete this entry? This action cannot be undone.')) {
                try {
                    await deleteDoc(doc(db, 'hourly_tracking', docId));
                    
                    // Reload current date entries
                    const currentDate = dateSelector.value;
                    if (currentDate) {
                        await loadEntriesForDate(currentDate);
                    }
                    
                    alert('Entry deleted successfully');
                } catch (error) {
                    console.error('Error deleting entry:', error);
                    alert('Error deleting entry. Please try again.');
                }
            }
        };
        
        // Close modal function
        window.closeEditModal = function() {
            editModal.style.display = 'none';
            currentEditId = null;
            editForm.reset();
        };
        
        // Close modal when clicking the X
        document.querySelector('.close').addEventListener('click', closeEditModal);
        
        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === editModal) {
                closeEditModal();
            }
        });
        
        // Handle edit form submission
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentEditId) return;
            
            try {
                const date = document.getElementById('editDate').value;
                const startTime = document.getElementById('editStartTime').value;
                const endTime = document.getElementById('editEndTime').value;
                
                // Create datetime objects
                const startDateTime = new Date(`${date}T${startTime}`);
                const endDateTime = new Date(`${date}T${endTime}`);
                
                // Update document
                await updateDoc(doc(db, 'hourly_tracking', currentEditId), {
                    StartTime: Timestamp.fromDate(startDateTime),
                    EndTime: Timestamp.fromDate(endDateTime),
                    Todo: document.getElementById('editTodo').value,
                    Done: document.getElementById('editDone').value,
                    Forfeit: document.getElementById('editForfeit').value,
                    Freedom: document.getElementById('editFreedom').value
                });
                
                // Close modal and reload data
                closeEditModal();
                
                // Reload current date entries
                const currentDate = dateSelector.value;
                if (currentDate) {
                    await loadEntriesForDate(currentDate);
                }
                
                alert('Entry updated successfully');
            } catch (error) {
                console.error('Error updating entry:', error);
                alert('Error updating entry. Please try again.');
            }
        });

        // Load initial data
        loadAvailableDates();
    </script>
</body>
</html>
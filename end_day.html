<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>End Your Day</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 700px;
            margin: 30px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .navigation {
            text-align: center;
            margin-bottom: 20px;
        }
        .navigation a {
            color: #4CAF50;
            text-decoration: none;
            margin: 0 10px;
        }
        .navigation a:hover {
            text-decoration: underline;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        .required::after {
            content: " *";
            color: red;
        }
        input[type="date"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 80px;
            resize: vertical;
            font-family: Arial, sans-serif;
        }
        .question-number {
            color: #666;
            font-size: 12px;
            margin-right: 5px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 20px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .message {
            padding: 12px;
            border-radius: 4px;
            margin: 20px 0;
            text-align: center;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .start-response {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }
        .start-response h3 {
            margin-top: 0;
            color: #2e7d32;
        }
        .category-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }
        .category-title {
            color: #4CAF50;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: capitalize;
        }
        .comparison-box {
            background-color: #fff3e0;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            border: 1px solid #ffb74d;
        }
        .comparison-box strong {
            color: #e65100;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="navigation">
            <a href="index.html">‚Üê Home</a> | 
            <a href="start_day.html">Start Day Form</a> | 
            <a href="daily_reports.html">View Reports</a> | 
            <a href="admin.html">Admin</a>
        </div>
        
        <h1>End Your Day</h1>
        
        <div id="startResponse" style="display:none;" class="start-response">
            <h3>Your Morning Plan</h3>
            <div id="startContent"></div>
        </div>

        <div id="message"></div>
        
        <form id="endDayForm">
            <div id="formContent" class="loading">Loading questions...</div>
            <button type="submit" id="submitBtn" style="display:none;">Submit</button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAv2tgr09braWjrKSsyZNbw9ZgdGyrZIDM",
            authDomain: "tracking-17d26.firebaseapp.com",
            projectId: "tracking-17d26",
            storageBucket: "tracking-17d26.firebasestorage.app",
            messagingSenderId: "506730679610",
            appId: "1:506730679610:web:8f28cbc0a5f05f37ab1403"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let questions = [];
        let questionsByCategory = {};
        let startDayData = null;

        // Load questions from Firestore
        async function loadQuestions() {
            try {
                const snapshot = await getDocs(collection(db, 'form_questions'));
                questions = [];
                questionsByCategory = {};
                
                snapshot.forEach(doc => {
                    const question = doc.data();
                    if (question.active && question.forms.includes('end')) {
                        questions.push(question);
                        const category = question.category || 'general';
                        if (!questionsByCategory[category]) {
                            questionsByCategory[category] = [];
                        }
                        questionsByCategory[category].push(question);
                    }
                });

                // Sort questions within each category
                Object.keys(questionsByCategory).forEach(category => {
                    questionsByCategory[category].sort((a, b) => (a.order_end || 999) - (b.order_end || 999));
                });

                // Sort questions overall by order_end
                questions.sort((a, b) => (a.order_end || 999) - (b.order_end || 999));
                
                renderForm();
            } catch (error) {
                console.error('Error loading questions:', error);
                document.getElementById('formContent').innerHTML = 
                    '<div class="error">Error loading questions. Please refresh the page.</div>';
            }
        }

        // Render the form with questions grouped by category
        function renderForm() {
            const formContent = document.getElementById('formContent');
            formContent.innerHTML = '';

            // Group questions by category order
            const categoryOrder = ['meta', 'reflection', 'planning', 'learning', 'emotional', 'productivity', 'mindfulness', 'mindset', 'health', 'goals'];
            
            categoryOrder.forEach(category => {
                if (questionsByCategory[category] && questionsByCategory[category].length > 0) {
                    if (category !== 'meta') {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.className = 'category-section';
                        
                        const categoryTitle = document.createElement('div');
                        categoryTitle.className = 'category-title';
                        categoryTitle.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                        categoryDiv.appendChild(categoryTitle);
                        
                        questionsByCategory[category].forEach(question => {
                            categoryDiv.appendChild(createQuestionElement(question));
                        });
                        
                        formContent.appendChild(categoryDiv);
                    } else {
                        // Meta category (date) goes at the top without section
                        questionsByCategory[category].forEach(question => {
                            formContent.appendChild(createQuestionElement(question));
                        });
                    }
                }
            });

            // Show submit button
            document.getElementById('submitBtn').style.display = 'block';
            
            // Set today's date by default
            const dateInput = document.getElementById('question_date');
            if (dateInput) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
            }

            // Load today's start response
            loadStartDayResponse();
        }

        // Create a question element
        function createQuestionElement(question) {
            const div = document.createElement('div');
            div.className = 'form-group';

            // Check if this is a shared question and we have start day data
            const isSharedQuestion = question.forms.includes('start') && question.forms.includes('end');
            if (isSharedQuestion && startDayData && startDayData.answers[question.id]) {
                const comparisonBox = document.createElement('div');
                comparisonBox.className = 'comparison-box';
                comparisonBox.innerHTML = `<strong>Your morning response:</strong><br>${startDayData.answers[question.id]}`;
                div.appendChild(comparisonBox);
            }

            const label = document.createElement('label');
            label.setAttribute('for', `question_${question.id}`);
            
            const questionNumber = document.createElement('span');
            questionNumber.className = 'question-number';
            questionNumber.textContent = `${question.order_end}.`;
            label.appendChild(questionNumber);
            
            const labelText = document.createElement('span');
            labelText.textContent = question.text;
            if (question.required) {
                labelText.className = 'required';
            }
            label.appendChild(labelText);
            
            div.appendChild(label);

            if (question.type === 'date') {
                const input = document.createElement('input');
                input.type = 'date';
                input.id = `question_${question.id}`;
                input.name = question.id;
                input.required = question.required || false;
                div.appendChild(input);
            } else {
                const textarea = document.createElement('textarea');
                textarea.id = `question_${question.id}`;
                textarea.name = question.id;
                textarea.required = question.required || false;
                textarea.placeholder = 'Enter your response here...';
                div.appendChild(textarea);
            }

            return div;
        }

        // Load today's start day response
        async function loadStartDayResponse() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const q = query(
                    collection(db, 'daily_reflections'),
                    where('formType', '==', 'start'),
                    where('date', '==', today),
                    limit(1)
                );
                
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    startDayData = snapshot.docs[0].data();
                    displayStartResponse(startDayData);
                    
                    // Re-render form to show comparisons
                    renderForm();
                }
            } catch (error) {
                console.error('Error loading start response:', error);
            }
        }

        // Display start day response
        function displayStartResponse(data) {
            const startDiv = document.getElementById('startResponse');
            const startContent = document.getElementById('startContent');
            
            let html = '';
            
            // Show key planning questions from morning
            const keyQuestions = ['daily_hourly_plan', 'accomplish_today', 'intentions_focus', 'time_box_order'];
            keyQuestions.forEach(qId => {
                if (data.answers[qId]) {
                    const question = questions.find(q => q.id === qId) || 
                                    { text: qId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) };
                    html += `<strong>${question.text}</strong><br>${data.answers[qId]}<br><br>`;
                }
            });
            
            if (html) {
                startContent.innerHTML = html;
                startDiv.style.display = 'block';
            }
        }

        // Handle form submission
        document.getElementById('endDayForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const messageDiv = document.getElementById('message');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            try {
                const formData = new FormData(e.target);
                const answers = {};
                
                // Collect all answers
                for (const [key, value] of formData.entries()) {
                    if (value.trim()) {
                        answers[key] = value.trim();
                    }
                }
                
                // Get the date value
                const dateValue = answers.date || new Date().toISOString().split('T')[0];
                
                // Save to Firestore
                await addDoc(collection(db, 'daily_reflections'), {
                    date: dateValue,
                    formType: 'end',
                    timestamp: Timestamp.now(),
                    answers: answers,
                    questionsVersion: "1.0"
                });
                
                messageDiv.className = 'message success';
                messageDiv.textContent = 'Your daily reflection has been saved successfully!';
                
                // Clear form
                e.target.reset();
                
                // Reset date to today
                const dateInput = document.getElementById('question_date');
                if (dateInput) {
                    dateInput.value = dateValue;
                }
                
                // Scroll to top
                window.scrollTo(0, 0);
                
            } catch (error) {
                console.error('Error submitting form:', error);
                messageDiv.className = 'message error';
                messageDiv.textContent = 'Error saving your response. Please try again.';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit';
            }
        });

        // Initialize
        loadQuestions();
    </script>
</body>
</html>